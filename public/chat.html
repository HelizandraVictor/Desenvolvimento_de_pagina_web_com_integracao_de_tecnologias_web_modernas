<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/estilo.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">Memórias</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">Início</a></li>
                    <li class="nav-item"><a class="nav-link" href="favoritos.html">Favoritos</a></li>
                    <li class="nav-item"><a class="nav-link active" href="chat.html">Chat</a></li>
                    <li class="nav-item"><a class="nav-link" href="painel.html">Relatórios</a></li>
                    <li class="nav-item"><a class="nav-link" href="sobre.html">Sobre</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="usernameForm" class="card p-4 mb-4">
            <h2 class="text-center mb-3">Entrar no Chat</h2>
            <form id="joinForm">
                <div class="mb-3">
                    <label for="username" class="form-label">Seu Nome</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">Entrar</button>
            </form>
        </div>

        <div id="chatArea" class="card p-4" style="display: none;">
            <h2 class="text-center mb-3">Chat</h2>
            <div id="messages" class="mb-3" style="height: 300px; overflow-y: auto;"></div>
            <form id="messageForm">
                <div class="input-group">
                    <input type="text" class="form-control" id="message" placeholder="Digite sua mensagem..." required>
                    <button type="submit" class="btn btn-primary">Enviar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let ws = null;
        const usernameForm = document.getElementById('usernameForm');
        const chatArea = document.getElementById('chatArea');
        const messages = document.getElementById('messages');
        const messageForm = document.getElementById('messageForm');
        const joinForm = document.getElementById('joinForm');

        joinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            if (username) {
                usernameForm.style.display = 'none';
                chatArea.style.display = 'block';
                connectWebSocket(username);
            }
        });

        function connectWebSocket(username) {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws?username=${encodeURIComponent(username)}`);

            ws.onopen = () => {
                addMessage('server', 'Conectado ao servidor!');
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'server') {
                        addMessage('server', data.message);
                    } else if (data.type === 'user') {
                        addMessage(data.username, data.message);
                    }
                } catch (error) {
                    addMessage('server', 'Erro ao processar mensagem: ' + error.message);
                }
            };

            ws.onclose = () => {
                addMessage('server', 'Desconectado do servidor. Tente recarregar a página.');
                chatArea.style.display = 'none';
                usernameForm.style.display = 'block';
            };

            ws.onerror = () => {
                addMessage('server', 'Erro na conexão com o servidor.');
            };
        }

        messageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const message = document.getElementById('message').value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ type: 'message', message }));
                addMessage('Você', message);
                document.getElementById('message').value = '';
            }
        });

        function addMessage(sender, message) {
            const messageElement = document.createElement('div');
            messageElement.className = sender === 'Você' ? 'text-end mb-2' : 'mb-2';
            messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
            messages.appendChild(messageElement);
            messages.scrollTop = messages.scrollHeight;
        }
    </script>
</body>
</html>